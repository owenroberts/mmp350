---
layout: slides
title: Users display
week: 9
---

<div class="slide">
	<p>Now that our users can make posts, we need to do a couple of things to change our data in order to make it easier for user posts to be viewed by other users.</p>
	<p>First, we'll update our <code>/create</code> user page to save the user name, and potentially other info, in the database, where the posts will be saved as well.</p>
	<p>Second, we'll create a <code>/users</code> route to display all of the current users of the application.</p>
</div>

<div class="slide">
	<h2>User name</h2>
	<p>In the <code>/create</code> route, we saved a user to the Authentication table.</p>
	<p>We need to make sure to also get the user name to use for displaying their posts.</p>
	<p>Here's the function we used before:</p>
	<pre><code>function createUser() {
	firebase.auth().createUserWithEmailAndPassword(emailInput.value, passwordInput.value)
		.then(function(user) {
			user.updateProfile({
				displayName: nameInput.value
			}).then(function(user) {
				location.href = "/";
			}, function(error) {
				console.log('error', error);
			});
		})
		.catch(function(error) {
			const errorMessage = document.getElementById("errorMessage");
			errorMessage.textContent = error.message;
		});
}</code></pre>
</div>

<div class="slide">
	<p>That function takes the user input and creates their Authentication entry.</p>
	<p>We can add some code that references the user table in the database to make sure we have the user name there as well.  This will introduce a new Firebase method, <code>.set()</code>.</p>
	<p>Once we've created the user, we will add their display name to the database:</p>
	<pre><code>firebase.auth().createUserWithEmailAndPassword(emailInput.value, passwordInput.value)
		.then(function(user) {
			const db = firebase.database();
			const ref = db.ref('/users/' + user.uid);
			ref.set({ name: nameInput.value });</code></pre>
	<p>The rest of that function stays the same.</p>
</div>

<div class="slide">
	<p>Now the firebase database will store the user name along with their posts, referenced with the user id.</p>
	<img src="users.png" alt="">
</div>

<div class="slide">
	<h2>Display all users</h2>
	<p>To display all of the users on a single page, we need to create a <code>/users</code> route and then grab a reference to all the users in the database.</p>
	<p>Then, using a <code>users.ejs</code> template, we can render links to each individual user page.</p>
</div>

<div class="slide">
	<p>First we need a reference to the database.</p>
	<p>In <code>server.js</code> right after the <code>const firebaseAdmin</code> code, let's add a reference to the database.</p>
	<pre><code>// leave this the same
const firebaseAdmin = admin.initializeApp({
	credential: admin.credential.cert(serviceAccount),
	databaseURL: 'https://your-node-app.firebaseio.com'
});
// reference to database
const db = firebaseAdmin.database();</code></pre>
</div>


<div class="slide">
	<p>Here's the route:</p>
	<pre><code>app.get('/users', function(request, response){
	const ref = db.ref('users');
	ref.once('value')
		.then(function(snapshot){
			response.render('users.ejs', {
				data: snapshot.val()
			});
		});
});</code></pre>
</div>

<div class="slide">
	<p>First we have a typical route, with a request and response.</p>
	<p>We get a references to the <code>users</code> table in the database.</p>
	<p><code>ref.once('value')</code> gets all of the users in the table.</p>
	<p>This returns a promise, which is handled with <code>.then</code>.  The argument, <code>snapshot</code> is the current data that is available.</p>
	<p>We want to pass the data from that snapshot, <code>snapshot.val()</code> to our template as the <code>data</code> argument.</p>
</div>

<div class="slide">
	<p>Our <code>users.ejs</code> template looks similar to other templates, so let's copy and paste the main tempalte from <code>home.ejs</code>Â and then just delete the <code>form</code> element for the write a post button.</p>
	<pre><code class="html">&lt;% include partials/head.ejs %&gt;
&lt;body&gt;
	&lt;% include partials/header.ejs %&gt;
	&lt;!-- display users here --&gt;
	&lt;% include partials/footer.ejs %&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>

<div class="slide">
	<p>Here's the markup and EJS to display the users:</p>
	<pre><code>&lt;div id="users"&gt;
	&lt;h2&gt;Users&lt;/h2&gt;
	&lt;% let keys = Object.keys(data); %&gt;
	&lt;% keys.forEach(function(key) { %&gt;
		&lt;% let user = data[key]; %&gt;
		&lt;div class="user"&gt;
			&lt;a href="/user/&lt;%= key %&gt;"&gt;&lt;%= user.name %&gt;&lt;/a&gt;
		&lt;/div&gt;
	&lt;% }); %&gt; 
&lt;/div&gt;</code></pre>
</div>

<div class="slide">
	<p>Because <code>data</code> is an object, we need to use <code>keys.forEach</code> to iterate over each of the components.  You can use <code>&lt;%= JSON.stringify(data); %&gt;</code> to see that data displayed on the HTML page.</p>
	<p>The hyperlink is built using the user's id, which is the key of each object in the users table in the database, which we will set up as another route in the next section.</p>
</div>