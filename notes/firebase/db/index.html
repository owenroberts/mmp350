---
layout: slides
title: Firebase Database
week: 5
---

<div class="slide">
	<p>Last week we created users for our app.  This week we will start connecting the users to our database.</p>
</div>

<div class="slide">
	<h2>Firebase Database</h2>
	<p>Next we'll make a function but first we have to set up the database in the Firebase Console.</p>
	<p>Firebase has a new database called Cloud Store, but we want to work with the <note>Realtime Database</note> for our app, so scroll down and choose that one.</p>
</div>

<div class="slide">
	<img src="database.png" alt="">
</div>

<div class="slide">
	<p>In the Database tab, click <note>Create Database</note>.</p>
	<p>We can practice adding data manually here.  Firebase is awesome because we can see how the data is structured and watch it update in real time.</p>
</div>

<div class="slide">
	<img src="data.png" alt="">
</div>

<div class="slide">
	<h2>Rules</h2>
	<p>Let's also take a quick look at the Rules tab.  This determines which users can access to read or write to the database.</p>
</div>

<div class="slide">
	<img src="rules.png" alt="">
</div>

<div class="slide">
	<p>The default rules look like this.</p>
	<div class="ex">{
	"rules": {
		".read": true,
		".write": true
	}
}</div>
	<p>This basically means anyone can access any part of the database.  That's not a good rule set.  Let's update the <code>".write"</code> rule.</p>
</div>

<div class="slide">
	<div class="ex">{
	"rules": {
		".read": true,
		".write": "auth != null"
	}
}</div>
	<p>This is a really basic rule that says if you are not authenticated you cannot write anything to the database, but you can still read content from the database.</p>
</div>


<div class="slide">
	<p>Later when we add posting, we'll restrict these rules further based on different parts of the database.</p>
	<p>Here is <a href="https://gist.github.com/codediodeio/6dbce1305b9556c2136492522e2100f6" target="_blank">a list</a> of some good default Firebase rules.</p>
</div>


<div class="slide">
	<h2>Add a user to the database</h2>
	<p>We're going to update the <code>updateUser</code> function in <note>auth.js</note> to add the new user to the database.</p>
	<p>To do this we will use <code>credential.user.uid</code>, the unique user ID generated by the Firebase Authentication table, as the user key.</p>
</div>

<div class="slide">
	<p>First, for this to work, we need to add the <code>firebase-database.js</code> module in our HTML file.</p>
	<div class="ex" data-err>&lt;script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-app.js"&gt;&lt;/script&gt;
&lt;script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-auth.js"&gt;&lt;/script&gt;
&lt;script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-database.js"&gt;&lt;/script&gt;</div>
</div>

<div class="slide">
	<div class="ex">createButton.onclick = function() {
	const promise = firebase.auth().createUserWithEmailAndPassword(emailInput.value, passwordInput.value);
	promise.catch(function(error) {
		errorMessage.textContent = error.message;
	});
	promise.then(function(response) {
		createUser(response.user);
	});
};

function createUser(user) {
	const db = firebase.database();
	const ref = db.ref('users').child(user.uid);
	const promise = ref.update({
		userName: userInput.value
	});
	promise.then(function() {
		location.href = 'index.html';
	});
}</div>
</div>

<div class="slide">
	<img src="user.png">
</div>

<div class="slide">
	<p>Now that we have users, let's update our database rules to restrict users from writing to the users part of the database unless their login uid matches the page uid.</p>
	<div class="ex">{
	"rules": {
		"users": {
			"$uid": {
				".read": true,
				".write": "$uid === auth.uid"
			}
		}, 	
		".read": true,
		".write": false
	}
}</div>
	<p>Here the <code>"$uid"</code> represents whichever user's profile is loaded, matching the reference inside the <code>"users"</code> part of the database.</p>
</div>

<div class="slide">
	<h2>Display Data</h2>
	<p>Now that we have stored a user in the database, we want to display the user information on their profile page.</p>
	<p>We'll start by adding a link to the profile page.</p>
</div>

<div class="slide">
	<p>Then update the <code>authState</code> function in <note>auth.js</note> to add a link using the <code>uid</code>.</p>
	<p>By adding the user id as a search term, with the <code>?</code> separator in the URL, we can retrieve the user info from the database by referencing the <code>uid</code>.</p>
</div>

<div class="slide">
	<div class="ex">const displayName = document.getElementById("user-name");
const profileButton = document.getElementById("profile-button");

firebase.auth().onAuthStateChanged(function(user) {
	if (user) {
		document.body.classList.add('auth');
		const userRef = firebase.database().ref('users').child(user.uid);
		userRef.once('value', function(snapshot) {
			const userInfo = snapshot.val();
			displayName.textContent = "Welcome, " + userInfo.displayName;
			profileButton.onclick = function() {
				location.href = "profile.html";
			};
		});
	} else {
		document.body.classList.remove('auth');
		displayName.textContent = "";
	}
});</div>
</div>

<div class="slide">
	<p>To create a profile page, let's make a new HTML file called <note>user.html</note>.  This page will show users profiles to be viewed by other users, or edited if the user views their own profile.</p>
	<p>This page will be almost identical to <note>index.html</note> except we will add a new script, <note>js/profile.js</note> and a new HTML section for the profile information.</p>
</div>

<div class="slide">
	<div class="ex" data-lang="html">&lt;div id="main"&gt;
	&lt;input id="profile-name" placeholder="User name"&gt;
	&lt;textarea id="bio" placeholder="Write your bio."&gt;&lt;/textarea&gt;
	&lt;button id="update-profile"&gt;Update Profile&lt;/button&gt;
&lt;/div&gt;</div>
</div>

<div class="slide">
	<p>Our script will get the <code>uid</code> from the profile link, which looks something like this.</p>
	<pre><code>http://localhost/user.html?uid=Ge8r8xjMCUZMhRUEIPf8xdxOcMy1</code></pre>
	<p>That <code>uid</code> is used to reference the user's information from the database.</p>
</div>

<div class="slide">
	<div class="ex">const profileName = document.getElementById('profile-name');
const bioInput = document.getElementById('bio');
const updateButton = document.getElementById('update-profile');

const uid = location.search.split('=')[1];
const userRef = firebase.database().ref('users').child(uid);

userRef.on('value', function(snapshot) {
	const userInfo = snapshot.val();
	profileName.value = userInfo.userName;
	if (userInfo.bio) {
		bioInput.value = userInfo.bio;
	}
});</div>
</div>

<div class="slide">
	<p><code>ref.on('value')</code> is an event that triggers when the database detects data has been added or changed at this location.  Test this by changing the data manually in Firebase.</p>
	<p>The data should update without reloading the page.  This is the <em>realtime</em> aspect of Firebase</p>
	<p><code>ref.once('value')</code> can be used if the data should not be updated in realtime.</p>
</div>

<div class="slide">
	<p>Firebase refers to the data returned by events as <note>snapshots</note>.  That's why the argument of <code>updateUser</code> is <code>snapshot</code>.</p>
	<p><code>snapshot.val()</code> is used to get the actual data from the event.  The <code>snapshot</code> itself has more properties that can be used to add other events and responses. </p>
</div>

<div class="slide">
	<h2>Updating data</h2>
	<p>Starting with the profile, our user should be able to edit their information after it has been added to the database.</p>
	<p>We'll start with the username.</p>
	<p>The user will only be able to edit this information if they are viewing their own profile page.</p>
</div>

<div class="slide">
	<div class="ex">updateButton.onclick = function() {
	userRef.update({
		userName: profileName.value,
		bio: bioInput.value
	});
};</div>
</div>

<div class="slide">
	<p>The edit button should only be visible if the user is logged in, so we can add to the CSS where we display content based on the <code>.logged-in</code> in class.</p>
	<p>The <code>#update-profile</code> section will not be displayed until the edit button is clicked.</p>
</div>

<div class="slide">
	<div class="ex" data-lang="css">#edit, #profile-edit {
	display: none;
}
.logged-in #edit {
	display: block;
}</div>
</div>