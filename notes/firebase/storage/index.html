---
layout: slides
title: Storage
week: 11
---

<div class="slide">
	<p>The Firebase Database can only save basic data like numbers, strings and booleans.  This is great for storing user posts, passwords and likes.</p>
	<p>If we want to save files like images or videos we need to use the Storage area in Firebase.</p>
</div>

<div class="slide">
	<p>To set up Storage, start by clicking on the Storage link in the Firebase menu.</p>
	<img src="menu.png" alt="">
</div>

<div class="slide">
	<p>You will be prompted to "Get Started".</p>
	<img src="get_started.png" alt="">
</div>

<div class="slide">
	<p>Then you will approve the default security rules.</p>
	<img src="security.png" alt="">
</div>

<div class="slide">
	<p>This will create an empty storage folder where we can add media files.</p>
	<img src="empty.png" alt="">
</div>

<div class="slide">
	<h2>Profile</h2>
	<p>We're going to start by giving our users the ability to add a Profile picture.  To do this we need to upload an image to Storage and then get the URL where the image is stored and save it in the database with the user.</p>
</div>

<!-- <div class="slide">
	<h2>Profile page</h2>
	<p>We'll start by adding a profile page.  This is a separate page from the <note>index.html</note>, but it has a lot of similarities, so we can begin by duplicating <note>index.html</note> and renaming it <note>profile.html</note>.</p>
</div>

<div class="slide">
	<p>Before leaving <note>index.html</note> let's update the menu with a link to the profile page.</p>
	<div class="ex" data-lang="html">&lt;ul id="menu"&gt;
	&lt;li&gt;&lt;a href="profile.html"&gt;Profile&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Friends&lt;/li&gt;
	&lt;li&gt;All Users&lt;/li&gt;
&lt;/ul&gt;</div>
</div>

<div class="slide">
	<p>Over on <note>profile.html</note> remember to update this link to go back to the homepage.</p>
	<div class="ex" data-lang="html">&lt;li&gt;&lt;a href="index.html"&gt;Home&lt;/a&gt;&lt;/li&gt;</div>
</div>

<div class="slide">
	<p>For the HTML, we can delete the main content sections <code>#posts</code> and <code>#write-post</code>.</p>
	<p>We'll replace that with the <code>#profile</code> section.</p>
	<p>In the profile section we'll add a file input for the user to upload a photo.  That's all we'll add for now.</p>
</div> -->

<div class="slide">
	<div class="ex" data-lang="html">&lt;div id="profile"&gt;
	&lt;h2&gt;My Profile&lt;/h2&gt;
	&lt;p id="profile-name"&gt;&lt;/p&gt;
	&lt;div id="add-photo"&gt;
		&lt;p&gt;Add a profile image:&lt;/p&gt;
		&lt;input id="profile-photo-file" type="file" name="profile-img" accept="image/gif, image/jpeg, image/png"&gt;
		&lt;button id="submit-photo"&gt;Submit Image&lt;/button&gt;
	&lt;/div&gt;
	&lt;img id="profile-photo" width="200"&gt;
&lt;/div&gt;</div>
</div>

<div class="slide">
	<p>Next, let's update the scripts in <note>profile.html</note>.</p>
	<p>We still need <note>js/auth.js</note>, we'll leave that there.  But we can delete <note>js/posts.js</note> and <note>js/publish.js</note>.</p>
	<p>We'll replace those with just <note>js/profile.js</note>.</p>
</div>

<div class="slide">
	<h2>Upload image</h2>
	<p>To upload the image, we need listen for when the user click the submit image button and then grab the file and put it in Firebase storage.</p>
	<p>Once in storage, we can grab the URL for the image to add to the database and user account.</p>
</div>

<div class="slide">
	<p>Listen for the user click.</p>
	<div class="ex">const submitButton = document.getElementById('submit-photo');
submitButton.addEventListener('click', function() {
	// get file
	// upload file
});</div>
</div>

<div class="slide">
	<p>Get the file from the HTML input.</p>
	<div class="ex">const file = document.getElementById('profile-photo-file').files[0];</div>
</div>

<div class="slide">
	<p>The storage reference is structured the same way as the firebase database reference.</p>
	<div class="ex">const storage = firebase.storage();
const user = firebase.auth().currentUser;
const ref = storage.ref('users').child(user.uid).child('profile-photo');
const filePromise = ref.put(file);</div>
</div>

<div class="slide">
	<p>With the <code>filePromise</code> we can add the photo URL and use it to update the database and user account.</p>
	<p>To get the photo URL we need to use another method that returns a promise, <code>getDownloadURL()</code>.  To do this we can use a common structure with Promises.  We return the result of <code>photo.ref.getDownloadURL()</code> and add another <code>.then()</code> to deal with the new Promise created.</p>
</div>

<div class="slide">
	<div class="ex">function updatePhoto(url) {
	user.updateProfile({url: photoURL});
	document.getElementById('profile-photo').src = url;
	firebase.database().ref('users').child(user.uid).update({profilePhoto: url});
}

filePromise.then(function(photo) {
	return photo.ref.getDownloadURL();
}).then(updatePhoto);</div>
</div>


<div class="slide">
	<p>You should see the image appear in the Storage files.</p>
	<img src="storage.png" alt="">
</div>

<div class="slide">
	<p>And the URL will be added to the Database.</p>
	<img src="db.png" alt="">
</div>

<div class="slide">
	<h2>Displaying the user image</h2>
	<p>These reference will allow us to display the user photo when they're logged in and next to the posts that they write.</p>
	<p>We can create an image in the <code>createPost</code> function.</p>

</div>

<div class="slide">
	<div class="ex">function createPost(post) {
	const postDiv = document.createElement('div');
	postDiv.classList.add('post');
	// rest of post ...
	
	const photoDiv = document.createElement('div');
	photoDiv.classList.add('photo');
	const photo = new Image();
	photo.src = post.profilePhoto;

	photoDiv.appendChild(photo);
	postDiv.appendChild(photoDiv);
}</div>
</div>